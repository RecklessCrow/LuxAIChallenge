import os
from datetime import datetime

from luxai2021.game.constants import Constants, LuxMatchConfigs_Default

CONFIGS = LuxMatchConfigs_Default

# Observation Vector Sizes
NUM_IDENTIFIERS = 3
NUM_GAME_STATES = 14
UNIT_VECTOR_SIZE = 7
NUM_RESOURCES = (5 * UNIT_VECTOR_SIZE) + (3 * 3 * UNIT_VECTOR_SIZE)
OBSERVATION_SHAPE = (NUM_IDENTIFIERS + NUM_GAME_STATES + NUM_RESOURCES,)
RESOURCE_LIST = [Constants.RESOURCE_TYPES.WOOD, Constants.RESOURCE_TYPES.COAL, Constants.RESOURCE_TYPES.URANIUM]

# Observation Constants
MAX_RESEARCH = 200.0
MAX_UNIT_COUNT = 30
MAX_CITY_COUNT = 30
STARTING_CITIES = 1
STARTING_UNITS = 1

NUM_STEPS_IN_DAY = 30
NUM_STEPS_IN_NIGHT = 10

# Reward Constants
MAX_REWARD = 1
MIN_REWARD = -MAX_REWARD

FUEL_DEPOSITED_REWARD_MODIFIER = 0.001
WOOD_GATHERED_REWARD_MODIFIER = 0.0001
COAL_GATHERED_REWARD_MODIFIER = WOOD_GATHERED_REWARD_MODIFIER * 10
URANIUM_GATHERED_REWARD_MODIFIER = WOOD_GATHERED_REWARD_MODIFIER * 40

RESEARCH_REWARD_MODIFIER = 0.1
RESEARCH_GOAL_MET_MODIFIER = 0.1
COAL_UNLOCKED = MAX_REWARD
URANIUM_UNLOCKED = MAX_REWARD

GAME_WIN = MAX_REWARD
GAME_LOSS = MIN_REWARD

# Unused
# CITY_REWARD_MODIFIER = 0.5
# NEGATIVE_CITY_MODIFIER = 1.25
# UNIT_REWARD_MODIFIER = 0.1
# NEGATIVE_UNIT_MODIFIER = 1.25
# CITY_STANDING_REWARD_MODIFIER = CITY_REWARD_MODIFIER * 2

# Hyper Parameters
LEARNING_RATE = 0.0001
GAMMA = 0.995
GAE_LAMBDA = 0.95
BATCH_SIZE = 4096
TRAINING_STEPS = 10_000_000
NUM_STEPS = BATCH_SIZE

# Multiprocessing
NUM_EVAL_ENVS = 4
NUM_EVAL_GAMES = 5
NUM_ENVS = os.cpu_count()

# Logging
NUM_REPLAYS = 10
SAVE_FREQ = (TRAINING_STEPS // NUM_REPLAYS) // NUM_ENVS

TIME_STAMP = datetime.now().strftime('%m-%d_%H-%M-%S')

CHECKPOINT_PATH = os.path.join("..", "checkpoints")
if not os.path.exists(CHECKPOINT_PATH):
    os.mkdir(CHECKPOINT_PATH)

LOGS_PATH = os.path.join("..", "logs")
CALLBACKS_PATH = os.path.join(LOGS_PATH, f"{TIME_STAMP}")

MODEL_CHECKPOINT_PATH = os.path.join(CHECKPOINT_PATH, TIME_STAMP)
MODEL_PATH = os.path.join("..", "models", f"{TIME_STAMP}.zip")
SAVED_MODEL_PATH = os.path.join("..", "checkpoints", "10-28_12-22-27_step2000000.zip")
